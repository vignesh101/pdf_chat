<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Document Chat</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-brand">
            <h1>Document Chat</h1>
            <span class="tag">RAG</span>
          </div>
          <div class="sidebar-actions">
            <button class="new-chat-btn" id="new-chat" title="Start new chat">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
            </button>
            <button class="sidebar-toggle" id="sidebar-close" aria-label="Close sidebar">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="sidebar-content">
          <section class="uploader">
            <h3>Upload Documents</h3>
            <form id="upload-form">
              <div class="dropzone" id="dropzone">
                <input type="file" id="file" name="file" multiple />
                <div class="dz-instructions">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                  <span>Drop files here or click to browse</span>
                </div>
              </div>
              <button type="submit" class="upload-btn">Upload Files</button>
              <div id="upload-status" class="upload-status"></div>
            </form>
          </section>

          <section class="chat-history">
            <div class="history-header">
              <h3>Chat History</h3>
              <button id="btn-clear" type="button" class="clear-btn" title="Clear chat history">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                </svg>
              </button>
            </div>
            <div id="history-list" class="history-list"></div>
            <div id="history-meta" class="history-meta"></div>
          </section>
        </div>

        <div class="sidebar-footer">
          <div class="config-info">
            <div class="config-item">Model: <code>{{ model_name }}</code></div>
            {% if proxy_url %}<div class="config-item">Proxy: <code>{{ proxy_url }}</code></div>{% endif %}
            {% if base_url %}<div class="config-item">Base URL: <code>{{ base_url }}</code></div>{% endif %}
            {% if disable_ssl %}<div class="config-item warn">SSL Verify: disabled</div>{% endif %}
          </div>
        </div>
      </aside>

      <!-- Main Chat Area -->
      <main class="main-content">
        <header class="chat-header">
          <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="3" y1="6" x2="21" y2="6"/>
              <line x1="3" y1="12" x2="21" y2="12"/>
              <line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
          </button>
          <h1>Document Chat</h1>
        </header>

        <div class="chat-container">
          <div id="messages" class="messages"></div>
          <div class="chat-input-container">
            <form id="chat-form" class="chat-form">
              <div class="input-wrapper">
                <textarea id="message" rows="1" placeholder="Message Document Chat..." autocomplete="off"></textarea>
                <button id="btn-send" type="submit" aria-label="Send message">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22,2 15,22 11,13 2,9 22,2"/>
                  </svg>
                </button>
              </div>
            </form>
          </div>
        </div>
      </main>
    </div>

    <!-- Sidebar backdrop for mobile -->
    <div class="sidebar-backdrop" id="sidebar-backdrop"></div>

    <script>
      const $ = (sel) => document.querySelector(sel);
      const messagesEl = $("#messages");
      const uploadForm = $("#upload-form");
      const chatForm = $("#chat-form");
      const uploadStatus = $("#upload-status");
      const dropzone = $("#dropzone");
      const btnClear = $('#btn-clear');
      const historyList = $('#history-list');
      const historyMeta = $('#history-meta');
      const btnSend = $('#btn-send');

      // Sidebar elements
      const sidebar = $('#sidebar');
      const sidebarToggle = $('#sidebar-toggle');
      const sidebarClose = $('#sidebar-close');
      const sidebarBackdrop = $('#sidebar-backdrop');
      const newChatBtn = $('#new-chat');

      function escapeHtml(str) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return (str || '').replace(/[&<>"']/g, (ch) => map[ch]);
      }

      function mdToHtml(text) {
        if (!text) return '';
        let html = escapeHtml(text);
        html = html.replace(/```([a-zA-Z0-9_-]+)?\n([\s\S]*?)```/g, (_, lang, code) => {
          return `<pre class="code-block"><code class="lang-${lang || 'text'}">${code.replace(/\n$/, '')}</code></pre>`;
        });
        html = html.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
        html = html.replace(/(https?:\/\/[\w.-]+(?:\/[\w\-._~:/?#[\]@!$&'()*+,;=.]+)?)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
        html = html.replace(/\n\n+/g, '</p><p>').replace(/\n/g, '<br/>');
        return `<p>${html}</p>`;
      }

      function messageElFor(m) {
        const wrap = document.createElement('div');
        wrap.className = 'msg ' + (m.role === 'user' ? 'user' : 'assistant');
        const row = document.createElement('div');
        row.className = 'msg-row';
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = m.role === 'user' ? 'You' : 'AI';
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        const body = document.createElement('div');
        body.className = 'body';
        body.innerHTML = mdToHtml(m.text || '');
        const tools = document.createElement('div');
        tools.className = 'tools';
        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'tool copy';
        copyBtn.textContent = 'Copy';
        copyBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          try { await navigator.clipboard.writeText(m.text || ''); copyBtn.textContent = 'Copied!'; setTimeout(()=> copyBtn.textContent = 'Copy', 1200); } catch (_) {}
        });
        tools.appendChild(copyBtn);
        bubble.appendChild(body);
        bubble.appendChild(tools);
        if (m.role !== 'user' && Array.isArray(m.sources) && m.sources.length) {
          const details = document.createElement('details');
          details.className = 'sources';
          const summary = document.createElement('summary');
          summary.textContent = `Sources (${m.sources.length})`;
          details.appendChild(summary);
          const list = document.createElement('ol');
          list.className = 'sources-list';
          m.sources.forEach((s) => {
            const li = document.createElement('li');
            li.className = 'source-item';
            const meta = document.createElement('div');
            meta.className = 'meta';
            const file = s.file_name ? s.file_name : (s.file_id || 'local');
            meta.textContent = `${file}  â€¢  score: ${typeof s.score === 'number' ? s.score.toFixed(3) : s.score}`;
            const preview = document.createElement('div');
            preview.className = 'preview';
            preview.textContent = (s.text || '').slice(0, 500);
            li.appendChild(meta);
            li.appendChild(preview);
            list.appendChild(li);
          });
          details.appendChild(list);
          bubble.appendChild(details);
        }
        row.appendChild(avatar);
        row.appendChild(bubble);
        wrap.appendChild(row);
        return wrap;
      }

      function appendMessageObj(m) {
        const el = messageElFor(m);
        messagesEl.appendChild(el);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function renderHistoryList(messages) {
        if (!Array.isArray(messages)) messages = [];
        historyList.innerHTML = '';

        if (messages.length === 0) {
          historyList.innerHTML = '<div class="empty-history">No messages yet</div>';
          historyMeta.textContent = '';
          return;
        }

        messages.forEach((m, index) => {
          const item = document.createElement('div');
          item.className = 'history-item ' + (m.role || '');

          const content = document.createElement('div');
          content.className = 'history-content';
          content.textContent = (m.text || '').slice(0, 100) + (m.text && m.text.length > 100 ? '...' : '');

          const timestamp = document.createElement('div');
          timestamp.className = 'history-timestamp';
          timestamp.textContent = m.role === 'user' ? 'You' : 'Assistant';

          item.appendChild(content);
          item.appendChild(timestamp);
          historyList.appendChild(item);
        });

        const count = messages.length || 0;
        historyMeta.textContent = `${count} message${count === 1 ? '' : 's'}`;
      }

      // Sidebar toggle functionality
      function toggleSidebar() {
        sidebar.classList.toggle('collapsed');
        sidebarBackdrop.classList.toggle('active');
      }

      function closeSidebar() {
        sidebar.classList.add('collapsed');
        sidebarBackdrop.classList.remove('active');
      }

      function openSidebar() {
        sidebar.classList.remove('collapsed');
        sidebarBackdrop.classList.add('active');
      }

      async function refreshMessages() {
        try {
          const res = await fetch('/messages');
          const data = await res.json();
          if (!data.ok) return;
          messagesEl.innerHTML = '';
          (data.messages || []).forEach(m => appendMessageObj(m));
          renderHistoryList(data.messages || []);
        } catch (e) {
          console.error(e);
        }
      }

      // Drag & drop uploads
      let droppedFiles = [];
      const dropEvents = ['dragenter','dragover','dragleave','drop'];
      dropEvents.forEach(evt => dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); }));
      ;['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, () => dropzone.classList.add('dragging')));
      ;['dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, () => dropzone.classList.remove('dragging')));
      dropzone.addEventListener('drop', (e) => {
        const files = Array.from(e.dataTransfer.files || []);
        if (files.length) {
          droppedFiles = droppedFiles.concat(files);
          uploadStatus.textContent = `${droppedFiles.length} file(s) ready`;
        }
      });
      dropzone.addEventListener('click', () => {
        $('#file').click();
      });
      $('#file').addEventListener('change', (e) => {
        const files = Array.from(e.target.files || []);
        if (files.length) {
          droppedFiles = droppedFiles.concat(files);
          uploadStatus.textContent = `${droppedFiles.length} file(s) ready`;
          e.target.value = '';
        }
      });

      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData();
        const toSend = droppedFiles;
        if (!toSend.length) {
          uploadStatus.textContent = 'No files selected.';
          return;
        }
        toSend.forEach(f => fd.append('file', f, f.name));
        uploadStatus.textContent = 'Uploading...';
        try {
          const res = await fetch('/upload', { method: 'POST', body: fd });
          const data = await res.json();
          if (data.ok) {
            uploadStatus.textContent = `Uploaded ${data.file_ids.length} file(s)`;
            droppedFiles = [];
          } else {
            uploadStatus.textContent = `Error: ${data.error || 'upload failed'}`;
          }
        } catch (err) {
          uploadStatus.textContent = 'Upload failed.';
        }
      });

      chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = $("#message");
        const text = input.value.trim();
        if (!text) return;
        appendMessageObj({ role: 'user', text });
        input.value = '';
        btnSend.disabled = true;
        const thinking = document.createElement('div');
        thinking.className = 'msg assistant thinking';
        thinking.innerText = 'Thinkingâ€¦';
        messagesEl.appendChild(thinking);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        try {
          const res = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
          });
          const data = await res.json();
          if (data.ok) {
            thinking.remove(); // Remove thinking indicator
            await refreshMessages();
          } else {
            thinking.innerText = 'Error: ' + (data.error || 'failed');
          }
        } catch (err) {
          thinking.innerText = 'Request failed.';
        } finally {
          btnSend.disabled = false;
        }
      });

      // Shift+Enter for newline, Enter to send; auto-resize
      const msgInput = $("#message");
      msgInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          chatForm.requestSubmit();
        }
      });
      msgInput.addEventListener('input', () => {
        msgInput.style.height = 'auto';
        msgInput.style.height = Math.min(200, msgInput.scrollHeight) + 'px';
      });

      // Sidebar event listeners
      sidebarToggle.addEventListener('click', toggleSidebar);
      sidebarClose.addEventListener('click', closeSidebar);
      sidebarBackdrop.addEventListener('click', closeSidebar);

      // Handle escape key to close sidebar
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !sidebar.classList.contains('collapsed')) {
          closeSidebar();
        }
      });

      btnClear.addEventListener('click', async () => {
        const sure = confirm('Clear chat history for this session?');
        if (!sure) return;
        try {
          const res = await fetch('/clear', { method: 'POST' });
          const data = await res.json();
          if (data.ok) {
            await refreshMessages();
          } else {
            alert('Failed to clear: ' + (data.error || 'unknown error'));
          }
        } catch (e) {
          alert('Request failed while clearing.');
        }
      });

      newChatBtn.addEventListener('click', async () => {
        try {
          const res = await fetch('/clear', { method: 'POST' });
          const data = await res.json();
          if (data.ok) {
            await refreshMessages();
          } else {
            alert('Failed to start new chat: ' + (data.error || 'unknown error'));
          }
        } catch (e) {
          alert('Request failed while starting new chat.');
        }
      });

      // Initial load
      refreshMessages();
    </script>
  </body>
  </html>
